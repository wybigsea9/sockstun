name: "Build SO Only"

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_so:
    name: Build Native Libraries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Setup Android SDK & NDK
        run: |
          sudo apt-get update -y && sudo apt-get install -y wget unzip file git openjdk-17-jdk
          git submodule foreach git submodule update --init

          # 下载并解压 commandlinetools
          wget https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip
          mkdir -p sdk/cmdline-tools/latest
          unzip -q commandlinetools-linux-13114758_latest.zip -d sdk/cmdline-tools/temp
          mv sdk/cmdline-tools/temp/cmdline-tools/* sdk/cmdline-tools/latest/
          rm -rf sdk/cmdline-tools/temp

          export ANDROID_HOME=$PWD/sdk
          export ANDROID_SDK_ROOT=$PWD/sdk
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH

          # 接受许可证并安装 NDK
          yes | sdkmanager --sdk_root=$PWD/sdk --licenses
          sdkmanager --sdk_root=$PWD/sdk "ndk;25.2.9519653"

      - name: Clean old builds
        run: |
          rm -rf jni/libs obj
          mkdir -p jni/libs/armeabi-v7a

      - name: Build .so
        run: |
          export NDK_HOME=$PWD/sdk/ndk/25.2.9519653
          cd jni
          $NDK_HOME/ndk-build NDK_APPLICATION_MK=Application.mk APP_BUILD_SCRIPT=Android.mk
          cd ..
          
          # 拷贝 .so 到输出目录
          mkdir -p output_so
          cp jni/libs/armeabi-v7a/*.so output_so/

      - name: Upload .so artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: output_so/
          if-no-files-found: error
          retention-days: 1
